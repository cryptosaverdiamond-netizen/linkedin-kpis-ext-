// AUDIT COMPLET DE L'EXTENSION LINKEDIN
// Script pour v√©rifier TOUS les √©l√©ments avant de valider

console.log('üîç AUDIT COMPLET EXTENSION LINKEDIN - D√©marrage...');

const AUDIT_CONFIG = {
    dashboard: {
        url_pattern: '/dashboard/',
        required_kpis: [
            'global_posts_impressions_last_7d',
            'followers', 
            'profile_views_90d',
            'search_appearances_last_week'
        ],
        kpi_keywords: {
            'global_posts_impressions_last_7d': ['impression', 'vue', 'reach', 'port√©e', '7 jour', '7 day'],
            'followers': ['follower', 'abonn√©', 'connection', 'connexion', 'r√©seau'],
            'profile_views_90d': ['vue de profil', 'profile view', 'profil vu', '90 jour', '90 day'],
            'search_appearances_last_week': ['recherche', 'search', 'apparition', 'appearance', 'semaine', 'week']
        }
    },
    posts: {
        url_pattern: '/recent-activity/all/',
        required_elements: [
            'post_containers',
            'post_urns',
            'reactions',
            'comments', 
            'shares',
            'timestamps'
        ],
        repost_keywords: ['repost', 'repartage', 'partag√©', 'repost√©', 'shared by']
    }
};

// Fonction principale d'audit
function auditExtension() {
    const url = window.location.href;
    console.log(`üåê Audit de: ${url}`);
    
    const results = {
        url: url,
        timestamp: new Date().toISOString(),
        page_type: null,
        status: 'unknown',
        issues: [],
        warnings: [],
        success: [],
        details: {}
    };
    
    if (url.includes(AUDIT_CONFIG.dashboard.url_pattern)) {
        results.page_type = 'dashboard';
        return auditDashboard(results);
    } else if (url.includes(AUDIT_CONFIG.posts.url_pattern)) {
        results.page_type = 'posts';
        return auditPosts(results);
    } else {
        results.status = 'error';
        results.issues.push('Page non support√©e pour l\'audit');
        return results;
    }
}

// Audit du dashboard
function auditDashboard(results) {
    console.log('\nüìä === AUDIT DASHBOARD ===');
    
    results.details = {
        kpi_found: {},
        selectors_tested: {},
        context_analysis: {}
    };
    
    // 1. V√©rifier la pr√©sence des KPI
    const config = AUDIT_CONFIG.dashboard;
    
    config.required_kpis.forEach(kpi => {
        console.log(`\nüéØ Audit KPI: ${kpi}`);
        
        const kpiResult = {
            found: false,
            values: [],
            selectors_working: [],
            context_matches: []
        };
        
        // Tester les s√©lecteurs de l'extension
        const selectors = [
            '.text-body-large-bold.t-black',
            'div',
            '.text-body-large-bold',
            'p.text-body-large-bold',
            '[class*="text-body-large"]'
        ];
        
        selectors.forEach(selector => {
            try {
                const elements = document.querySelectorAll(selector);
                if (elements.length > 0) {
                    kpiResult.selectors_working.push({
                        selector: selector,
                        count: elements.length
                    });
                }
            } catch (e) {
                console.warn(`S√©lecteur invalide: ${selector}`);
            }
        });
        
        // Analyser le contexte pour ce KPI
        const keywords = config.kpi_keywords[kpi];
        const numberElements = Array.from(document.querySelectorAll('.text-body-large-bold, p.text-body-large-bold'))
            .filter(el => {
                const text = el.textContent?.trim();
                return text && /\d+/.test(text);
            });
        
        numberElements.forEach(element => {
            const value = element.textContent.trim();
            const container = element.closest('div, section, article') || element.parentElement;
            const contextText = container?.textContent?.toLowerCase() || '';
            
            const hasKeyword = keywords.some(keyword => contextText.includes(keyword.toLowerCase()));
            
            if (hasKeyword) {
                kpiResult.found = true;
                kpiResult.values.push(value);
                kpiResult.context_matches.push({
                    value: value,
                    context: contextText.substring(0, 100),
                    matched_keywords: keywords.filter(k => contextText.includes(k.toLowerCase()))
                });
            }
        });
        
        results.details.kpi_found[kpi] = kpiResult;
        
        // R√©sultats
        if (kpiResult.found) {
            console.log(`   ‚úÖ KPI trouv√©: ${kpiResult.values.join(', ')}`);
            results.success.push(`KPI ${kpi} d√©tect√©`);
        } else {
            console.log(`   ‚ùå KPI non trouv√©`);
            results.issues.push(`KPI ${kpi} manquant`);
        }
    });
    
    // 2. V√©rifier l'extraction du user_id
    console.log(`\nüë§ Audit User ID:`);
    
    const profileLink = document.querySelector('a[href*="/in/"]');
    if (profileLink) {
        const href = profileLink.getAttribute('href');
        const match = href.match(/\/in\/([^\/]+)/);
        if (match) {
            console.log(`   ‚úÖ User ID trouv√©: ${match[1]}`);
            results.success.push(`User ID d√©tect√©: ${match[1]}`);
            results.details.user_id = match[1];
        }
    } else {
        console.log(`   ‚ùå User ID non trouv√©`);
        results.issues.push('User ID manquant');
    }
    
    // 3. V√©rifier la langue
    console.log(`\nüá´üá∑ Audit Langue:`);
    const lang = document.documentElement.lang;
    if (lang && lang.startsWith('fr')) {
        console.log(`   ‚úÖ Langue fran√ßaise d√©tect√©e: ${lang}`);
        results.success.push('Page en fran√ßais');
    } else {
        console.log(`   ‚ö†Ô∏è Langue non fran√ßaise: ${lang}`);
        results.warnings.push(`Langue d√©tect√©e: ${lang}`);
    }
    
    // Statut final
    if (results.issues.length === 0) {
        results.status = 'success';
    } else if (results.issues.length <= 2) {
        results.status = 'warning';
    } else {
        results.status = 'error';
    }
    
    return results;
}

// Audit des posts
function auditPosts(results) {
    console.log('\nüìù === AUDIT POSTS ===');
    
    results.details = {
        containers: [],
        urns: [],
        metrics: {},
        reposts: [],
        timestamps: []
    };
    
    // 1. V√©rifier les conteneurs de posts
    console.log(`\nüì¶ Audit Conteneurs:`);
    
    const containers = document.querySelectorAll('.feed-shared-update-v2');
    console.log(`   Conteneurs trouv√©s: ${containers.length}`);
    
    if (containers.length === 0) {
        results.issues.push('Aucun conteneur de post trouv√©');
        results.status = 'error';
        return results;
    }
    
    results.success.push(`${containers.length} conteneurs d√©tect√©s`);
    
    // 2. Analyser chaque post
    const postsToAnalyze = Array.from(containers).slice(0, 5);
    
    postsToAnalyze.forEach((container, index) => {
        console.log(`\nüéØ AUDIT POST ${index + 1}:`);
        
        const postAnalysis = {
            index: index + 1,
            urn: null,
            metrics: {},
            timestamp: null,
            is_repost: false,
            issues: []
        };
        
        // URN
        const urn = container.getAttribute('data-urn');
        if (urn && urn.includes('urn:li:activity:')) {
            postAnalysis.urn = urn;
            console.log(`   ‚úÖ URN: ${urn}`);
        } else {
            postAnalysis.issues.push('URN manquant');
            console.log(`   ‚ùå URN non trouv√©`);
        }
        
        // M√©triques
        console.log(`   üìä M√©triques:`);
        
        // R√©actions
        const reactionsBtn = container.querySelector('button[aria-label*="r√©actions"]');
        if (reactionsBtn) {
            const reactionsMatch = reactionsBtn.getAttribute('aria-label').match(/(\d+)\s*r√©actions?/);
            if (reactionsMatch) {
                postAnalysis.metrics.reactions = parseInt(reactionsMatch[1]);
                console.log(`      ‚úÖ R√©actions: ${postAnalysis.metrics.reactions}`);
            }
        } else {
            postAnalysis.issues.push('R√©actions non trouv√©es');
            console.log(`      ‚ùå R√©actions non trouv√©es`);
        }
        
        // Commentaires
        const commentsBtn = container.querySelector('button[aria-label*="commentaires"]');
        if (commentsBtn) {
            const commentsMatch = commentsBtn.getAttribute('aria-label').match(/(\d+)\s*commentaires?/);
            if (commentsMatch) {
                postAnalysis.metrics.comments = parseInt(commentsMatch[1]);
                console.log(`      ‚úÖ Commentaires: ${postAnalysis.metrics.comments}`);
            }
        } else {
            postAnalysis.issues.push('Commentaires non trouv√©s');
            console.log(`      ‚ùå Commentaires non trouv√©s`);
        }
        
        // Republications
        const sharesBtn = container.querySelector('button[aria-label*="republications"]');
        if (sharesBtn) {
            const sharesMatch = sharesBtn.getAttribute('aria-label').match(/(\d+)\s*republications?/);
            if (sharesMatch) {
                postAnalysis.metrics.shares = parseInt(sharesMatch[1]);
                console.log(`      ‚úÖ Republications: ${postAnalysis.metrics.shares}`);
            }
        } else {
            console.log(`      ‚ö†Ô∏è Republications: 0 (normal si aucune)`);
        }
        
        // Timestamp
        const timeElement = container.querySelector('time[datetime], [class*="date"]');
        if (timeElement) {
            const datetime = timeElement.getAttribute('datetime') || timeElement.textContent;
            postAnalysis.timestamp = datetime;
            console.log(`      ‚úÖ Timestamp: ${datetime}`);
        } else {
            postAnalysis.issues.push('Timestamp manquant');
            console.log(`      ‚ùå Timestamp non trouv√©`);
        }
        
        // D√©tection repost
        const containerText = container.textContent.toLowerCase();
        const repostKeywords = AUDIT_CONFIG.posts.repost_keywords;
        postAnalysis.is_repost = repostKeywords.some(keyword => containerText.includes(keyword));
        
        if (postAnalysis.is_repost) {
            console.log(`      ‚ö†Ô∏è REPOST d√©tect√© - sera ignor√©`);
            results.details.reposts.push(postAnalysis);
        }
        
        console.log(`      Issues: ${postAnalysis.issues.length}`);
        
        results.details.containers.push(postAnalysis);
        
        if (postAnalysis.urn) {
            results.details.urns.push(postAnalysis.urn);
        }
    });
    
    // 3. V√©rifier l'extraction du user_id depuis l'URL
    console.log(`\nüë§ Audit User ID:`);
    const urlMatch = window.location.href.match(/\/in\/([^\/]+)\/recent-activity\/all/);
    if (urlMatch) {
        console.log(`   ‚úÖ User ID depuis URL: ${urlMatch[1]}`);
        results.success.push(`User ID d√©tect√©: ${urlMatch[1]}`);
        results.details.user_id = urlMatch[1];
    } else {
        console.log(`   ‚ùå User ID non extrait de l'URL`);
        results.issues.push('User ID manquant dans URL');
    }
    
    // Statut final
    const totalIssues = results.details.containers.reduce((sum, post) => sum + post.issues.length, 0);
    
    if (totalIssues === 0 && results.issues.length === 0) {
        results.status = 'success';
    } else if (totalIssues <= 3) {
        results.status = 'warning';
    } else {
        results.status = 'error';
    }
    
    return results;
}

// G√©n√©rer le rapport final
function generateAuditReport(results) {
    console.log('\nüìã === RAPPORT D\'AUDIT ===');
    
    console.log(`üåê URL: ${results.url}`);
    console.log(`üìÑ Type: ${results.page_type}`);
    console.log(`üìä Statut: ${results.status.toUpperCase()}`);
    
    if (results.success.length > 0) {
        console.log(`\n‚úÖ SUCC√àS (${results.success.length}):`);
        results.success.forEach(item => console.log(`   ‚Ä¢ ${item}`));
    }
    
    if (results.warnings.length > 0) {
        console.log(`\n‚ö†Ô∏è AVERTISSEMENTS (${results.warnings.length}):`);
        results.warnings.forEach(item => console.log(`   ‚Ä¢ ${item}`));
    }
    
    if (results.issues.length > 0) {
        console.log(`\n‚ùå PROBL√àMES (${results.issues.length}):`);
        results.issues.forEach(item => console.log(`   ‚Ä¢ ${item}`));
    }
    
    // Recommandations
    console.log(`\nüí° RECOMMANDATIONS:`);
    
    if (results.status === 'success') {
        console.log(`   üéâ L'extension devrait fonctionner parfaitement sur cette page !`);
    } else if (results.status === 'warning') {
        console.log(`   ‚ö†Ô∏è L'extension peut fonctionner mais avec des limitations`);
        console.log(`   üîß V√©rifiez les avertissements ci-dessus`);
    } else {
        console.log(`   üö® L'extension ne fonctionnera PAS correctement`);
        console.log(`   üõ†Ô∏è Corrigez les probl√®mes identifi√©s avant de continuer`);
    }
    
    console.log(`\nüíæ R√©sultats sauvegard√©s dans window.auditResults`);
    window.auditResults = results;
    
    console.log(`üìã Pour copier: copy(JSON.stringify(window.auditResults, null, 2))`);
    
    return results;
}

// Ex√©cution automatique
console.log('\nüöÄ D√©marrage de l\'audit...');
const auditResults = auditExtension();
const finalReport = generateAuditReport(auditResults);

// Export des fonctions
window.LinkedInAudit = {
    audit: auditExtension,
    report: generateAuditReport,
    results: finalReport
};